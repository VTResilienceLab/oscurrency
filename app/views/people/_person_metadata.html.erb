<% i = 0 %>
<%= f.fields_for :person_metadata do |pm| %>
  <% unless person.errors[:"person_metadata.#{extra_fields[i].key}"].empty? %>
    <div class="error-field">
  <% end %>
    <% case extra_fields[i].field_type %>
    <% when 'text_field' %>
      <%= pm.text_field :value, label: extra_fields[i].title %>
      <%= render partial: "person_metadata_error", locals: {p: person, extra_field: extra_fields[i]} %>
    <% when 'text_area' %>
      <%= pm.text_area :value, label: extra_fields[i].title, rows: 6 %>
      <%= render partial: "person_metadata_error", locals: {p: person, extra_field: extra_fields[i]} %>
    <% when 'collection_select' %>
      <%= pm.text_area :value, label: extra_fields[i].title %>
      <%= render partial: "person_metadata_error", locals: {p: person, extra_field: extra_fields[i]} %>
    <% end %>
    <%= pm.hidden_field :key, :value => extra_fields[i].key %>
  <% unless person.errors[:"person_metadata.#{extra_fields[i].key}"].empty? %>
    </div>
  <% end %>
  <% i = i + 1 %>
<% end %>